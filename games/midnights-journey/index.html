<!doctype html><html><head><meta charset="utf-8"/><title>Midnight's Journey</title><meta name="viewport" content="width=device-width,initial-scale=1"/><style>*{margin:0;padding:0;box-sizing:border-box}body{body{background:#07121A;color:#e0e6ed;font-family:Arial,sans-serif;overflow:hidden;height:100vh}color:#e0e6ed;font-family:Arial,sans-serif;overflow:hidden;height:100vh}.ld{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:6px 14px;border-radius:10px;font-weight:700;font-size:1.1em;color:#e0e6ed;text-align:center;z-index:10;margin-top:0px}.st{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,.7);padding:8px 14px;border-radius:10px;font-size:.9em;line-height:1.4em;color:#e0e6ed;max-width:220px}.lc{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.95);color:#fff;padding:40px 30px;border-radius:20px;text-align:center;display:none;z-index:9999;max-width:420px;line-height:1.4}#hd{display:none;position:fixed;left:50%;top:140px;transform:translateX(-50%);background:rgba(0,0,0,.85);padding:10px 14px;border-radius:10px;color:#e0e6ed;z-index:999}.ct{position:fixed;bottom:20px;right:20px;background:rgba(0,0,0,.8);padding:10px;border-radius:10px;color:#fff;z-index:10001;pointer-events:auto;display:grid;grid-template-columns:auto auto;gap:8px 12px;align-items:center}.ct-t{grid-column:1/span 2;justify-self:center;white-space:nowrap;font-size:.9rem;opacity:.85;text-shadow:0 1px 0 rgba(0,0,0,.3)}.ct button{border-radius:999px;padding:8px 24px;font-weight:600;background:#2f2f2f;color:#fff;cursor:pointer;font-size:12px;border:none}.ct button:nth-of-type(1){grid-column:1;justify-self:end}.ct button:nth-of-type(2){grid-column:2;justify-self:start}.sb{font-size:.9rem;opacity:.8}#vp{height:95vh;position:relative;overflow:hidden}#g{width:100%;height:100%;display:block}.lc button{border-radius:999px;padding:8px 24px;font-weight:600;background:#2f2f2f;color:#fff;cursor:pointer;font-size:12px;border:none;margin:0 5px}h1 {text-align: center;color: #FFF;text-shadow: 0 1px 3px rgba(0,0,0,.5);margin: 10px 0;font-size: 2em;position: relative;z-index: 10;}.star{position:absolute;background:#fff;border-radius:50%;animation:t 4s infinite}</style></head><body><h1>☁ Midnight's Journey ☁</h1><div id="s"></div><div class="ld"><span id="wl">World 1 • Level 1</span><div class="sb" id="ln">Shadow Dance</div></div><div id="hd">?</div><div id="vp"><canvas id="g"></canvas></div><div class="ct"><div class="ct-t">Rotate:Mouse • Zoom:Scroll • Move:WASD/Arrows</div><button id="bh" onclick="getHint()">Hint (<span id="hc">3</span>)</button><button onclick="rstLvl()">Reset</button></div><div class="st">
<div>Moves: <span id="mc">0</span></div><div>Targets: <span id="tc">0/0</span></div></div><div id="gc" class="lc" style="display:none"><h2>Game Complete</h2><p id="gs">All levels!</p><div style="margin-top:10px; display:flex; gap:10px; justify-content:center;"><button onclick="rstGame()">Play Again</button></div></div><div id="lc" class="lc"><h2>Level Complete!</h2><div id="sd" style="font-size:2em;margin:15px 0"></div><button onclick="cntToNxtLvl()">Continue</button><button onclick="rtyLvl()">Try Again</button></div><script>
let sts={totalMoves:0,levelsCleared:0,startAt:Date.now()};let isGameOver=!1;(w=>{const C=new AudioContext,s=()=>C.state=='suspended'&&C.resume(),K=()=>{s();const o=C.createOscillator(),g=C.createGain();o.type='triangle';o.connect(g);g.connect(C.destination);o.frequency.value=700;g.gain.setValueAtTime(.045,C.currentTime);o.start();o.stop(C.currentTime+.035)},J=()=>{s();const o=C.createOscillator(),g=C.createGain();o.type='sine';o.connect(g);g.connect(C.destination);o.frequency.value=440;g.gain.setValueAtTime(.06,C.currentTime);o.start();o.stop(C.currentTime+.06)};w.sfx={step:K,target:J};['pointerdown','keydown'].forEach(e=>document.addEventListener(e,s,{once:1}))})(window);
(()=>{class V3{constructor(x=0,y=0,z=0){this.x=x;this.y=y;this.z=z}set(x,y,z){this.x=x;this.y=y;this.z=z;return this}copy(v){this.x=v.x;this.y=v.y;this.z=v.z;return this}add(v){this.x+=v.x;this.y+=v.y;this.z+=v.z;return this}sub(v){this.x-=v.x;this.y-=v.y;this.z-=v.z;return this}multiplyScalar(s){this.x*=s;this.y*=s;this.z*=s;return this}length(){return Math.hypot(this.x,this.y,this.z)}normalize(){const l=this.length()||1;return this.multiplyScalar(1/l)}clone(){return new V3(this.x,this.y,this.z)}}
class M4{constructor(){this.m=new Float32Array(16);this.identity()}identity(){const m=this.m;m[0]=m[5]=m[10]=m[15]=1;m[1]=m[2]=m[3]=m[4]=m[6]=m[7]=m[8]=m[9]=m[11]=m[12]=m[13]=m[14]=0;return this}multiply(t){const a=this.m,b=t.m,r=new Float32Array(16);for(let i=0;i<4;i++){const x=a[i],y=a[i+4],z=a[i+8],w=a[i+12];r[i]=x*b[0]+y*b[1]+z*b[2]+w*b[3];r[i+4]=x*b[4]+y*b[5]+z*b[6]+w*b[7];r[i+8]=x*b[8]+y*b[9]+z*b[10]+w*b[11];r[i+12]=x*b[12]+y*b[13]+z*b[14]+w*b[15]}this.m=r;return this}static multiply(a,b){const r=new M4;r.m.set(a.m);return r.multiply(b)}translate(x,y,z){const t=new M4;t.m[12]=x;t.m[13]=y;t.m[14]=z;return this.multiply(t)}scale(x,y,z){const s=new M4;s.m[0]=x;s.m[5]=y;s.m[10]=z;return this.multiply(s)}rotateX(a){const c=Math.cos(a),s=Math.sin(a),r=new M4;r.m[5]=c;r.m[6]=s;r.m[9]=-s;r.m[10]=c;return this.multiply(r)}rotateY(a){const c=Math.cos(a),s=Math.sin(a),r=new M4;r.m[0]=c;r.m[2]=-s;r.m[8]=s;r.m[10]=c;return this.multiply(r)}rotateZ(a){const c=Math.cos(a),s=Math.sin(a),r=new M4;r.m[0]=c;r.m[1]=s;r.m[4]=-s;r.m[5]=c;return this.multiply(r)}static perspective(f,a,n,r){const t=1/Math.tan(f*Math.PI/360),d=1/(n-r),m=new M4;m.m[0]=t/a;m.m[5]=t;m.m[10]=(r+n)*d;m.m[11]=-1;m.m[14]=2*r*n*d;m.m[15]=0;return m}static lookAt(e,t,u){const z=new V3(e.x-t.x,e.y-t.y,e.z-t.z).normalize(),x=new V3(u.y*z.z-u.z*z.y,u.z*z.x-u.x*z.z,u.x*z.y-u.y*z.x).normalize(),y=new V3(z.y*x.z-z.z*x.y,z.z*x.x-z.x*x.z,z.x*x.y-z.y*x.x),m=(new M4).identity().m;m[0]=x.x;m[4]=x.y;m[8]=x.z;m[12]=-(x.x*e.x+x.y*e.y+x.z*e.z);m[1]=y.x;m[5]=y.y;m[9]=y.z;m[13]=-(y.x*e.x+y.y*e.y+y.z*e.z);m[2]=z.x;m[6]=z.y;m[10]=z.z;m[14]=-(z.x*e.x+z.y*e.y+z.z*e.z);return{m}}}
class O3D{constructor(){this.position=new V3;this.rotation=new V3;this.scale=new V3(1,1,1);this.children=[];this.parent=null;this.matrixWorld=new M4;this.visible=!0}add(c){c.parent&&c.parent.remove(c);c.parent=this;this.children.push(c);return this}remove(c){this.children=this.children.filter(x=>x!==c);c.parent=null;return this}updateMatrixWorld(p=null){const m=(new M4).identity().translate(this.position.x,this.position.y,this.position.z).rotateX(this.rotation.x).rotateY(this.rotation.y).rotateZ(this.rotation.z).scale(this.scale.x,this.scale.y,this.scale.z);this.matrixWorld=p?M4.multiply(p,m):m;for(const c of this.children)c.updateMatrixWorld(this.matrixWorld)}}
class Scene extends O3D{constructor(){super();this.isScene=!0}}class Camera extends O3D{constructor(f=60,a=1,n=.1,r=100){super();this.fov=f;this.aspect=a;this.near=n;this.far=r;this.target=new V3;this.up=new V3(0,1,0)}lookAt(x,y,z){this.target.set(x,y,z);return this}projectionMatrix(){return M4.perspective(this.fov,this.aspect,this.near,this.far)}viewMatrix(){return M4.lookAt(this.position,this.target,this.up)}}
class Geometry{constructor(v,i=null,n=null){this.vertices=new Float32Array(v);this.indices=i?new Uint16Array(i):null;this.normals=n?new Float32Array(n):null;this.mode='triangles';this._gl=null}}
class BoxGeometry extends Geometry{constructor(w=1,h=1,d=1){const x=w/2,y=h/2,z=d/2,v=[x,-y,-z,x,y,-z,x,y,z,x,-y,z,-x,-y,z,-x,y,z,-x,y,-z,-x,-y,-z,-x,y,-z,-x,y,z,x,y,z,x,y,-z,-x,-y,z,-x,-y,-z,x,-y,-z,x,-y,z,-x,-y,z,x,-y,z,x,y,z,-x,y,z,x,-y,-z,-x,-y,-z,-x,y,-z,x,y,-z],i=[];for(let f=0;f<6;f++){const b=f*4;i.push(b,b+1,b+2,b,b+2,b+3)}super(v,i,[1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1])}}
class StarGeometry extends Geometry{constructor(r=1,i=.4,p=5,d=.2){const v=[],I=[],N=[],A=Math.PI*2,H=Math.PI/2,s=[];for(let t=0;t<p*2;t++){const a=(t/(p*2))*A+H,R=t%2===0?r:i;s.push([Math.cos(a)*R,Math.sin(a)*R])}const h=d/2;let z=0;v.push(0,0,h);N.push(0,0,1);const F=z++,q=[];for(let t=0;t<s.length;t++)v.push(s[t][0],s[t][1],h),N.push(0,0,1),q.push(z++);for(let t=0;t<s.length;t++)I.push(F,q[t],q[(t+1)%s.length]);v.push(0,0,-h);N.push(0,0,-1);const B=z++,Q=[];for(let t=0;t<s.length;t++)v.push(s[t][0],s[t][1],-h),N.push(0,0,-1),Q.push(z++);for(let t=0;t<s.length;t++)I.push(B,Q[(t+1)%s.length],Q[t]);for(let t=0;t<s.length;t++){const n=(t+1)%s.length,dx=s[n][0]-s[t][0],dy=s[n][1]-s[t][1],l=Math.hypot(dx,dy)||1,nx=dy/l,ny=-dx/l,m=z;v.push(s[t][0],s[t][1],h,s[n][0],s[n][1],h,s[t][0],s[t][1],-h,s[n][0],s[n][1],-h);for(let i=0;i<4;i++)N.push(nx,ny,0);I.push(m,m+2,m+1,m+1,m+2,m+3);z+=4}super(v,I,N)}}
class EdgesGeometry extends Geometry{constructor(g){const v=g.vertices,i=g.indices,e=new Map;for(let t=0;t<i.length;t+=3){const a=i[t],b=i[t+1],c=i[t+2],x=v[3*a],y=v[3*a+1],z=v[3*a+2],dx1=v[3*b]-x,dy1=v[3*b+1]-y,dz1=v[3*b+2]-z,dx2=v[3*c]-x,dy2=v[3*c+1]-y,dz2=v[3*c+2]-z,nx=dy1*dz2-dz1*dy2,ny=dz1*dx2-dx1*dz2,nz=dx1*dy2-dy1*dx2,l=Math.hypot(nx,ny,nz)||1,n={nx:nx/l,ny:ny/l,nz:nz/l},addEdge=(a,b)=>{const k=(Math.min(a,b)<<16)|Math.max(a,b),d=e.get(k);d?(d.n2=n,d.count=2):e.set(k,{a:Math.min(a,b),b:Math.max(a,b),n1:n,count:1})};addEdge(a,b);addEdge(b,c);addEdge(c,a)}const o=[];e.forEach(d=>{(d.count===1||d.n1.nx*d.n2.nx+d.n1.ny*d.n2.ny+d.n1.nz*d.n2.nz<.999)&&o.push(d.a,d.b)});const p=[];for(let t=0;t<o.length;t+=2){const a=o[t],b=o[t+1];p.push(v[3*a],v[3*a+1],v[3*a+2],v[3*b],v[3*b+1],v[3*b+2])}super(p,null,null);this.mode='lines'}}
class Material{constructor({color:c=0xffffff,ambient:a=.35,diffuse:d=.9,emissive:e=0,emissiveIntensity:i=0,opacity:o=1,transparent:t=!1,depthTest:dt=!0,depthWrite:dw=!0}={}){this.color=new Float32Array([(c>>16&255)/255,(c>>8&255)/255,(c&255)/255,o]);this.emissive=new Float32Array([(e>>16&255)/255,(e>>8&255)/255,(e&255)/255,1]);this.ambient=a;this.diffuse=d;this.emissiveIntensity=i;this.transparent=t||o<1;this.depthTest=dt;this.depthWrite=dw}setColor(c){this.color[0]=(c>>16&255)/255;this.color[1]=(c>>8&255)/255;this.color[2]=(c&255)/255;return this}setEmissive(c){this.emissive[0]=(c>>16&255)/255;this.emissive[1]=(c>>8&255)/255;this.emissive[2]=(c&255)/255;return this}}
class Mesh extends O3D{constructor(g,m){super();this.geometry=g;this.material=m;this.isMesh=!0}}const MA={pulseEmissive(m,s=1,b=1){const t=.001*Date.now()*s,i=(.5*Math.sin(t)+.5)*b;m.emissiveIntensity=i}};
class Renderer{constructor({canvas:c=null}={}){this.canvas=c||document.createElement('canvas');this.gl=this.canvas.getContext('webgl',{antialias:!0,alpha:!0});if(!this.gl)throw new Error('WebGL not supported');this._initGL()}setSize(w,h){this.canvas.width=w;this.canvas.height=h;this.gl.viewport(0,0,w,h)}_compile(t,s){const g=this.gl,sh=g.createShader(t);g.shaderSource(sh,s);g.compileShader(sh);if(g.getShaderParameter(sh,g.COMPILE_STATUS))return sh;throw new Error(g.getShaderInfoLog(sh))}_link(v,f){const g=this.gl,p=g.createProgram();g.attachShader(p,v);g.attachShader(p,f);g.linkProgram(p);if(g.getProgramParameter(p,g.LINK_STATUS))return p;throw new Error(g.getProgramInfoLog(p))}_initGL(){const g=this.gl,vs=this._compile(g.VERTEX_SHADER,'attribute vec3 aPos,aNormal;uniform mat4 uProjection,uView,uModel;varying vec3 vN;void main(){gl_Position=uProjection*uView*uModel*vec4(aPos,1.0);vN=mat3(uModel)*aNormal;}'),fs=this._compile(g.FRAGMENT_SHADER,'precision mediump float;uniform vec3 uLightDir;uniform vec4 uColor,uEmissive;uniform float uAmbient,uDiffuse,uEmissiveIntensity,uHemiStrength;uniform vec3 uHemiTop,uHemiBottom;varying vec3 vN;void main(){vec3 N=normalize(vN);float l=max(dot(N,normalize(uLightDir)),0.0),h=clamp(0.5*N.y+0.5,0.0,1.0);vec3 b=uColor.rgb*(uAmbient+uDiffuse*l),hemi=mix(uHemiBottom,uHemiTop,h),lit=b*mix(vec3(1.0),hemi,uHemiStrength),em=uEmissive.rgb*uEmissiveIntensity;gl_FragColor=vec4(lit+em,uColor.a);}');this.p=this._link(vs,fs);this.l={aPos:g.getAttribLocation(this.p,'aPos'),aNormal:g.getAttribLocation(this.p,'aNormal'),uProjection:g.getUniformLocation(this.p,'uProjection'),uView:g.getUniformLocation(this.p,'uView'),uModel:g.getUniformLocation(this.p,'uModel'),uColor:g.getUniformLocation(this.p,'uColor'),uEmissive:g.getUniformLocation(this.p,'uEmissive'),uLightDir:g.getUniformLocation(this.p,'uLightDir'),uAmbient:g.getUniformLocation(this.p,'uAmbient'),uDiffuse:g.getUniformLocation(this.p,'uDiffuse'),uEmissiveIntensity:g.getUniformLocation(this.p,'uEmissiveIntensity'),uHemiTop:g.getUniformLocation(this.p,'uHemiTop'),uHemiBottom:g.getUniformLocation(this.p,'uHemiBottom'),uHemiStrength:g.getUniformLocation(this.p,'uHemiStrength')};g.enable(g.DEPTH_TEST);g.enable(g.CULL_FACE);g.cullFace(g.BACK);g.frontFace(g.CCW);g.clearColor(0,0,0,0)}_prepareGeometry(ge){const g=this.gl;if(!ge._gl){const vb=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,vb);g.bufferData(g.ARRAY_BUFFER,ge.vertices,g.STATIC_DRAW);let nb=null,ib=null,ic=0,ac=0;if(ge.normals){nb=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,nb);g.bufferData(g.ARRAY_BUFFER,ge.normals,g.STATIC_DRAW)}if(ge.indices){ib=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,ib);g.bufferData(g.ELEMENT_ARRAY_BUFFER,ge.indices,g.STATIC_DRAW);ic=ge.indices.length}else ac=ge.vertices.length/3;ge._gl={vbo:vb,nbo:nb,ibo:ib,idxCount:ic,arrCount:ac,isLines:ge.mode==='lines'}}}render(s,c,ld=[.6,1,.5],ht=[1,1,1],hb=[.5,.7,1],hs=0){const g=this.gl;c.aspect=(this.canvas.width||1)/(this.canvas.height||1);s.updateMatrixWorld(null);g.viewport(0,0,this.canvas.width,this.canvas.height);g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT);const meshes=[],lines=[];function a4(o){if(o.isMesh&&o.visible)(o.geometry.mode==='lines'?lines:meshes).push(o);for(const c of o.children)a4(c)}a4(s);const pm=c.projectionMatrix().m,vm=c.viewMatrix().m;g.useProgram(this.p);g.uniformMatrix4fv(this.l.uProjection,!1,pm);g.uniformMatrix4fv(this.l.uView,!1,vm);g.uniform3fv(this.l.uLightDir,new Float32Array(ld));g.uniform3fv(this.l.uHemiTop,new Float32Array(ht));g.uniform3fv(this.l.uHemiBottom,new Float32Array(hb));g.uniform1f(this.l.uHemiStrength,hs);for(const m of meshes){const ge=m.geometry;this._prepareGeometry(ge);const d=ge._gl;g.bindBuffer(g.ARRAY_BUFFER,d.vbo);g.vertexAttribPointer(this.l.aPos,3,g.FLOAT,!1,12,0);g.enableVertexAttribArray(this.l.aPos);if(d.nbo){g.bindBuffer(g.ARRAY_BUFFER,d.nbo);g.vertexAttribPointer(this.l.aNormal,3,g.FLOAT,!1,12,0);g.enableVertexAttribArray(this.l.aNormal)}else if(this.l.aNormal>=0)g.disableVertexAttribArray(this.l.aNormal);g.uniformMatrix4fv(this.l.uModel,!1,m.matrixWorld.m);const mat=m.material||new Material;if(mat.transparent){g.enable(g.BLEND);g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA)}else g.disable(g.BLEND);mat.depthTest!==!1?g.enable(g.DEPTH_TEST):g.disable(g.DEPTH_TEST);g.depthMask(mat.depthWrite!==!1);g.uniform4fv(this.l.uColor,mat.color);g.uniform4fv(this.l.uEmissive,mat.emissive||new Float32Array([0,0,0,1]));g.uniform1f(this.l.uAmbient,mat.ambient);g.uniform1f(this.l.uDiffuse,mat.diffuse);g.uniform1f(this.l.uEmissiveIntensity,mat.emissiveIntensity||0);if(d.ibo){g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,d.ibo);g.drawElements(g.TRIANGLES,d.idxCount,g.UNSIGNED_SHORT,0)}else{g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.drawArrays(g.TRIANGLES,0,d.arrCount)}}g.disable(g.CULL_FACE);g.useProgram(this.p);if(this.l.aNormal>=0)g.disableVertexAttribArray(this.l.aNormal);for(const l of lines){const ge=l.geometry;this._prepareGeometry(ge);const d=ge._gl;g.uniformMatrix4fv(this.l.uModel,!1,l.matrixWorld.m);g.uniform4fv(this.l.uColor,l.material?l.material.color:new Float32Array([1,1,1,1]));g.uniform4fv(this.l.uEmissive,new Float32Array([0,0,0,1]));g.uniform1f(this.l.uAmbient,1);g.uniform1f(this.l.uDiffuse,0);g.uniform1f(this.l.uEmissiveIntensity,0);g.bindBuffer(g.ARRAY_BUFFER,d.vbo);g.vertexAttribPointer(this.l.aPos,3,g.FLOAT,!1,12,0);g.enableVertexAttribArray(this.l.aPos);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.drawArrays(g.LINES,0,d.arrCount)}g.enable(g.CULL_FACE);g.disable(g.BLEND);g.depthMask(!0);g.enable(g.DEPTH_TEST)}}
function a0(m,c=0xffffff,s=1.001){const e=new Mesh(new EdgesGeometry(m.geometry),new Material({color:c,depthWrite:!1}));e.scale.set(m.scale.x*s,m.scale.y*s,m.scale.z*s);m.add(e);return e}
class OrbitControls{constructor(c,d){this.camera=c;this.dom=d;this.target=c.target.clone();const v=c.position.clone().sub(this.target);this.radius=v.length();this.theta=Math.atan2(v.x,v.z);this.phi=Math.acos(Math.min(Math.max(v.y/this.radius,-1),1));this.minRadius=2;this.maxRadius=30;this.minPhi=.05;this.maxPhi=Math.PI-.05;this.rotateSpeed=1;this.zoomSpeed=1;this._initEvents();this.update()}_initEvents(){const d=this.dom;let a=!1,m='rotate',x=0,y=0,p=t=>t.touches?{x:t.touches[0].clientX,y:t.touches[0].clientY}:{x:t.clientX,y:t.clientY};d.addEventListener('mousedown',t=>{a=!0;const i=p(t);x=i.x;y=i.y;m=t.button===2||t.shiftKey?'pan':'rotate';t.preventDefault()});window.addEventListener('mousemove',t=>{if(a){const i=p(t),dx=i.x-x,dy=i.y-y;x=i.x;y=i.y;if(m==='rotate'){this.theta-=.005*dx*this.rotateSpeed;this.phi-=.005*dy*this.rotateSpeed;this.phi=Math.max(this.minPhi,Math.min(this.maxPhi,this.phi))}else{const px=-.002*dx*this.radius,py=.002*dy*this.radius,sx=Math.sin(this.theta),cx=Math.cos(this.theta),r=new V3(cx,0,-sx),u=new V3(0,1,0);this.target.add(r.multiplyScalar(px).add(u.multiplyScalar(py)))}this.update()}});window.addEventListener('mouseup',()=>{a=!1});d.addEventListener('contextmenu',t=>t.preventDefault());d.addEventListener('wheel',t=>{const f=Math.exp(-.001*t.deltaY*this.zoomSpeed);this.radius*=f;this.radius=Math.max(this.minRadius,Math.min(this.maxRadius,this.radius));this.update()},{passive:!0});d.addEventListener('touchstart',t=>{if(t.touches.length===1){a=!0;m='rotate';x=t.touches[0].clientX;y=t.touches[0].clientY}},{passive:!1});d.addEventListener('touchmove',t=>{if(a&&t.touches.length===1&&m==='rotate'){const i=t.touches[0],dx=i.clientX-x,dy=i.clientY-y;x=i.clientX;y=i.clientY;this.theta-=.005*dx*this.rotateSpeed;this.phi-=.005*dy*this.rotateSpeed;this.phi=Math.max(this.minPhi,Math.min(this.maxPhi,this.phi));this.update()}},{passive:!1});d.addEventListener('touchend',()=>{a=!1})}update(){const s=Math.sin(this.phi),c=Math.cos(this.phi),sx=Math.sin(this.theta),cx=Math.cos(this.theta),p=new V3(this.target.x+this.radius*s*sx,this.target.y+this.radius*c,this.target.z+this.radius*s*cx);this.camera.position.copy(p);this.camera.lookAt(this.target.x,this.target.y,this.target.z)}}
window.M3D={Vector3:V3,Matrix4:M4,Object3D:O3D,Scene,PerspectiveCamera:Camera,Geometry,BoxGeometry,StarGeometry,EdgesGeometry,MeshLambertMaterial:Material,MaterialAnimator:MA,Mesh,WebGLRenderer:Renderer,a0,OrbitControls}})();
class Cat extends M3D.Object3D{constructor(t={}){super();this.baseY=t.baseY||0;this.scale.set(.3,.3,.3);this._yaw=0;this._targetYaw=null;this._buildCat()}_buildCat(){const{BoxGeometry:B,MeshLambertMaterial:M,Mesh:S}=M3D,b=new B(2.5,2.5,2.5),p=new B(.5,.5,.1),n=new B(.3,.3,.2),h=new B(1,.5,.2),r=new B(.25,.25,.25),o=new B(.5,.5,.5),d=new B(.6,.8,.4),w=new B(.4,.4,.4),l=new B(.4,1.8,.4),f=new B(.5,.2,.5),m1=new M({color:0,ambient:.4,diffuse:.8}),m2=new M({color:0xFFE82C,ambient:.8,diffuse:.4}),m3=new M({color:0,ambient:.8,diffuse:.4}),m4=new M({color:0xffffff,ambient:.8,diffuse:.4}),m5=new M({color:0x1a1a1a,ambient:.5,diffuse:.7}),a=new S(b,m1);a.position.set(0,1.25,0);this.add(a);M3D.a0(a,0,1.002);for(let[x,z]of[[-.5,-1.25],[.5,-1.225]]){let i=new S(p,m2);i.position.set(x,1.5,z);this.add(i);let j=new S(n,m3);j.position.set(x,1.5,-1.25);this.add(j)}let k=new S(h,m4);k.position.set(.06,.95,-1.225);this.add(k);k=new S(r,m1);k.position.set(.06,1.05,-1.4);this.add(k);k=new S(o,m1);k.position.set(0,1.4,1.4);this.add(k);for(let[x,z]of[[-.9,-1.002],[.9,-1.002]]){let e=new S(d,m1);e.position.set(x,2.6,z);this.add(e);M3D.a0(e,0,1.002);let i=new S(w,m4);i.position.set(x,2.7,z-.001);this.add(i);M3D.a0(i,0,1.002)}for(let[x,z]of[[-.7,-.8],[.7,-.8],[-.7,.8],[.7,.8]]){let g=new S(l,m1);g.position.set(x,.9,z);this.add(g);M3D.a0(g,0,1.002);let i=new S(f,m5);i.position.set(x,.1,z);this.add(i);M3D.a0(i,0,1.002)}}setFacing(d){const m={N:0,E:-Math.PI/2,S:Math.PI,W:Math.PI/2}[d.toUpperCase()];if(m!==undefined)this._targetYaw=m}faceStep(dx,dz){const a=dx===1&&dz===0?-Math.PI/2:dx===-1&&dz===0?Math.PI/2:dx===0&&dz===1?Math.PI:dx===0&&dz===-1?0:null;if(a!==null)this._targetYaw=a}update(dt){if(this._targetYaw===null)return;let d=this._targetYaw-this._yaw;while(d>Math.PI)d-=2*Math.PI;while(d<-Math.PI)d+=2*Math.PI;const s=Math.sign(d)*Math.min(Math.abs(d),8*dt);this._yaw+=s;while(this._yaw>Math.PI)this._yaw-=2*Math.PI;while(this._yaw<-Math.PI)this._yaw+=2*Math.PI;this.rotation.y=this._yaw;if(Math.abs(d)<.01){this._yaw=this._targetYaw;this.rotation.y=this._yaw;this._targetYaw=null}}}
const W=[{n:"Feather Isles",l:[{m:["11111","14321","11111"]},{m:["1111100","1000111","1003001","1150201","0100041","0111111"]},{m:["00111110","11100010","10301011","10100201","10000101","11010001","01400111","01111100"]},{m:["00001111","11111001","10003001","10021001","11011011","10000001","10410001","10011111","11110000"]}]},{n:"Crescent Cloud",l:[{m:["111110","120011","143301","110001","011001","001121","000111"]},{m:["1111100","1000110","1010011","1201301","1004001","1211311","1000010","1111110"]},{m:["1111000","1001111","1020201","1033141","1100001","0111111"]},{m:["1111000","1001110","1000011","1021301","1104001","0121311","0100010","0111110"]}]},{n:"Glimmer Aeries",l:[{m:["00011110","11110010","10300010","10021011","11012001","10400301","10001111","11111000"]},{m:["1111111","1000001","1010101","1203541","1000111","1111100"]},{m:["1111100","1000100","1040100","1033111","1120201","0100001","0111111"]},{m:["00111110","11100010","10301011","10100201","10000101","11312001","01400111","01111100"]}]},{n:"Starforge Valley",l:[{m:["11110000","10011100","10000111","10035401","11102101","00100001","00111111"]},{m:["01111100","01000100","11310111","10003401","10100101","10120201","10001111","11111000"]},{m:["1111111","1005001","1000001","1101011","0134210","0100010","0111110"]},{m:["01111100","01000110","11013011","10300001","12021001","11104011","00101010","00100010","00111110"]}]}];
const P=[{g:"4B7B68|365C4F",p:"E2EAD9|C0C7B9",G:"ADB5A8|8B9187",t:"386957|2A4E3F",T:"32433C|26312E",b:"9BB589|7D9170",a:"F2E38F|D5C86F",d:"linear-gradient(180deg, #B8FFD7 0%, #4B967E 30%, #0B1714 100%), radial-gradient(750px 370px at 40% 22%, rgba(140,255,200,0.08), transparent 68%)"},{g:"3F6578|2B4653",p:"D9E1EA|B6BBC0",G:"9DA9B4|7B838C",t:"345064|243844",T:"29363F|1A2228",b:"5CC5FF|3B99C7",a:"E4D27F|C4B15F",d:"linear-gradient(180deg, #D6F4FF 0%, #3E7D94 35%, #07121A 100%), radial-gradient(900px 450px at 50% 12%, rgba(140,210,255,0.10), transparent 75%)"},{g:"536D92|3A4E69",p:"E0DDF6|BCBAD3",G:"B1ADCA|8D89A7",t:"42567A|2E3E56",T:"343E4F|242C38",b:"C177FF|9C5DD4",a:"F6E983|D4C865",d:"linear-gradient(180deg, #D2E8FF 0%, #6F80C2 40%, #0A101F 100%), radial-gradient(850px 400px at 60% 15%, rgba(190,150,255,0.10), transparent 70%)"},{g:"7F6C56|5A4B3B",p:"F0E3CA|CBBDA8",G:"BFAF97|9B8D77",t:"66533E|4B3D2D",T:"4B382B|34251E",b:"FF8736|D16C29",a:"FFE47F|DCC562",d:"linear-gradient(180deg, #FFD7A3 0%, #AD7842 35%, #0D0A06 100%), radial-gradient(900px 420px at 55% 12%, rgba(255,180,100,0.14), transparent 65%)"}];
const{Scene,PerspectiveCamera,WebGLRenderer,Mesh,BoxGeometry,MeshLambertMaterial,a0,OrbitControls,Object3D,StarGeometry,EdgesGeometry,MaterialAnimator}=M3D,canvas=document.getElementById("g"),renderer=new WebGLRenderer({canvas}),scene=new Scene,cam=new PerspectiveCamera(45,1,.1,100);cam.position.set(6,8,9);cam.lookAt(0,.8,0);
const controls=new OrbitControls(cam,canvas);controls.minRadius=4;controls.maxRadius=30;const C={floor:0x31414d,rim:0x2a3944,box:0x2ec3d1,boxOK:0xffd54f,grass:0x4CAF50},G={unit:new BoxGeometry(1,1,1),tile:new BoxGeometry(1,.06,1)};
let cL=0,moves=0,catX=1,catY=1,gO=[],isMoving=!1,cW=0,gridW=0,gridH=0,halfX=0,halfZ=0,hintsThisLevel=3,hintTimeout=0,solutionPath=null;
const root=new Object3D;scene.add(root);const byId=new Map,tilesByCell=new Map,toWorldX=x=>x-halfX,toWorldZ=z=>z-halfZ,cellKey=(x,z)=>`${x},${z}`,x=(s,i=s.indexOf('|'))=>i>0?[parseInt(s.slice(0,i),16),parseInt(s.slice(i+1),16)]:[parseInt(s,16),parseInt(s,16)],clrHint=()=>{document.getElementById("hd").style.display='none';clearTimeout(hintTimeout)};
window.Board3D={clear(){for(const c of[...root.children])root.remove(c);byId.clear();tilesByCell.clear()},addTile(id,x,z,rim=!1,edgeColor=0xffffff){const m=new Mesh(G.tile,new MeshLambertMaterial({color:rim?C.rim:C.path,ambient:.45,diffuse:.85}));m.position.set(x,-.03,z);root.add(m);const e=a0(m,edgeColor,1);e.material.ambient=1;e.material.diffuse=0;byId.set(id,{kind:"tile",mesh:m});tilesByCell.set(cellKey(x,z),m)},
addGlow(id,x,z){const t=tilesByCell.get(cellKey(x,z));if(t)t.material=new MeshLambertMaterial({color:C.target,ambient:.55,diffuse:.9})},addBox(id,x,z,isOnTarget=!1){const c=new Object3D,b=new EdgesGeometry(G.unit),e=new MeshLambertMaterial({color:0xffffff,emissive:0x444444,emissiveIntensity:.1,opacity:.9,transparent:!0,ambient:1,diffuse:0,depthWrite:!1}),w=new Mesh(b,e);w.scale.set(.8,.8,.8);w.position.set(0,.4,0);const s=new StarGeometry(.28,.112,5,.2),cc=isOnTarget?C.boxOK:C.box,m=new MeshLambertMaterial({color:cc,emissive:cc,emissiveIntensity:.3,opacity:.95,transparent:!0,ambient:.7,diffuse:.5}),sc=new Mesh(s,m);sc.position.set(0,.42,0);sc._pulseSpeed=1.5;sc._basePulse=.4;c.add(w);c.add(sc);c.position.set(x,0,z);root.add(c);byId.set(id,{kind:"box",mesh:c})},
addCat(id,x,z){const cat=new Cat({baseY:.01});cat.position.set(x,0,z);root.add(cat);byId.set(id,{kind:"cat",mesh:cat});this._cat=cat},moveTo(id,x,z){const e=byId.get(id);if(e)e.mesh.position.set(x,e.mesh.position.y,z)},rcBx(id,isOnTarget){const e=byId.get(id);if(!e||e.kind!=="box")return;const core=e.mesh.children[1];if(core&&core.material){const nc=isOnTarget?C.boxOK:C.box;core.material.setColor(nc);core.material.setEmissive(nc)}},
faceCat(dx,dz){this._cat?.faceStep?.(dx,dz)},setCatFacing(dir){this._cat?.setFacing?.(dir)},update(dt){this._cat?.update?.(dt);byId.forEach(e=>{if(e.kind==="box"){const c=e.mesh.children[1];if(c&&c._pulseSpeed)MaterialAnimator.pulseEmissive(c.material,c._pulseSpeed,c._basePulse)}})}};
function a1(x,z,opts={}){const{canopyScale:cs=0.78,trunkScale:ts=0.22,canopyTallRange:ctr=[0.85,1.7]}=opts,wx=toWorldX(x),wz=toWorldZ(z),th=0.6,tg=new M3D.BoxGeometry(ts,th,ts),tm=new M3D.MeshLambertMaterial({color:C.trunk,ambient:.4,diffuse:.9}),t=new M3D.Mesh(tg,tm);t.position.set(wx,th/2,wz);root.add(t);M3D.a0(t,C.trunkEdge,1.002);const ch=ctr[0]+Math.random()*(ctr[1]-ctr[0]),cg=new M3D.BoxGeometry(cs,ch*0.8,cs),cm=new M3D.MeshLambertMaterial({color:C.tree,ambient:.5,diffuse:.8}),c=new M3D.Mesh(cg,cm);c.position.set(wx,th+(ch*0.8)/2,wz);root.add(c);M3D.a0(c,C.treeEdge,1.001);}
function a5(level) {const mapHeight = level.m.length;const mapWidth = Math.max(...level.m.map(row => row.length));let minX = mapWidth, maxX = -1, minY = mapHeight, maxY = -1;for (let y = 0; y < mapHeight; y++) {const row = level.m[y] || '';for (let x = 0; x < mapWidth; x++) {const cell = row[x];if (cell && cell !== ' ') {minX = Math.min(minX, x);maxX = Math.max(maxX, x);minY = Math.min(minY, y);maxY = Math.max(maxY, y);}}}const boardWidth = (maxX - minX + 1);const boardHeight = (maxY - minY + 1);const groundPadding = 0.1;const groundWidth = boardWidth + (groundPadding * 2);const groundDepth = boardHeight + (groundPadding * 2);const groundThickness = 1.8;const centerX = (minX + maxX) / 2 - halfX;const centerZ = (minY + maxY) / 2 - halfZ;const groundGeo = new M3D.BoxGeometry(groundWidth, groundThickness, groundDepth);const groundMat = new M3D.MeshLambertMaterial({ color: C.ground, ambient: .45, diffuse: .85 });const groundMesh = new M3D.Mesh(groundGeo, groundMat);groundMesh.position.set(centerX, -(groundThickness / 2) - 0.001, centerZ);root.add(groundMesh);M3D.a0(groundMesh, C.groundEdge, 1.002);return groundMesh;}
function a7(){const d=Math.min(2,window.devicePixelRatio||1),w=Math.round(canvas.clientWidth*d),h=Math.round(canvas.clientHeight*d);if(canvas.width!==w||canvas.height!==h){canvas.width=w;canvas.height=h;renderer.setSize(w,h)}}new ResizeObserver(a7).observe(canvas);a7();window.addEventListener("resize",a7);function a12(){gO=[];moves=0;const level=W[cW].l[cL];hintsThisLevel=3;document.getElementById("hc").textContent=hintsThisLevel;document.getElementById("bh").disabled=!1;document.getElementById("mc").textContent=moves;a21();clrHint();Board3D.clear();gridH=level.m.length;gridW=Math.max(...level.m.map(r=>r.length));halfX=gridW/2-.5;halfZ=gridH/2-.5;a5(level);for(let y=0;y<gridH;y++){const row=level.m[y]||'';for(let x=0;x<gridW;x++){const c=(x<row.length)?row[x]:' ',wx=toWorldX(x),wz=toWorldZ(y);if(c===' ')continue;switch(c){case'0':Board3D.addTile(`t_${x}_${y}`, wx, wz, false, C.pathEdge);if (a15(x, y, level)) {const tile = tilesByCell.get(cellKey(wx, wz));if (tile) {tile.material = new MeshLambertMaterial({ color: C.grass, ambient: .45, diffuse: .85 });const edges = tile.children.find(child => child.material && child.material.ambient === 1.0);if (edges) {edges.material.color = new Float32Array([(C.grassEdge >> 16 & 255) / 255,(C.grassEdge >> 8 & 255) / 255,(C.grassEdge & 255) / 255,1]);}}} else {const tile = tilesByCell.get(cellKey(wx, wz));if (tile) {tile.material = new MeshLambertMaterial({ color: C.path, ambient: .45, diffuse: .85 });}}break;case'1':Board3D.addTile(`t_${x}_${y}`,wx,wz,!1,c==='1'?C.grassEdge:C.pathEdge);if(c==='1'){const t=tilesByCell.get(cellKey(wx,wz));if(t)t.material=new MeshLambertMaterial({color:C.grass,ambient:.45,diffuse:.85})}if(Math.random()<0.1)a1(x,y);break;case'2':Board3D.addTile(`t_${x}_${y}`,wx,wz,!1,C.targetEdge);Board3D.addGlow(`g_${x}_${y}`,wx,wz);gO.push({type:'target',x,y});break;case'3':Board3D.addTile(`t_${x}_${y}`,wx,wz,!1,C.pathEdge);Board3D.addBox(`box_${x}_${y}`,wx,wz);gO.push({type:'box',x,y,id:`box_${x}_${y}`});break;case'4':Board3D.addTile(`t_${x}_${y}`,wx,wz,!1,C.pathEdge);catX=x;catY=y;Board3D.addCat('cat',wx,wz);Board3D.setCatFacing('S');break;case'5':Board3D.addTile(`t_${x}_${y}`,wx,wz,!1,C.targetEdge);Board3D.addGlow(`g_${x}_${y}`,wx,wz);gO.push({type:'target',x,y});Board3D.addBox(`box_${x}_${y}`,wx,wz,!0);gO.push({type:'box',x,y,id:`box_${x}_${y}`,onTarget:!0});break}}}a18();a22()}
function a15(x, y, level) {const map = level.m;const mapHeight = map.length;const mapWidth = Math.max(...map.map(row => row.length));if (y === 0 || y === mapHeight - 1) return true;if (x === 0 || x === mapWidth - 1) return true;const dirs = [[-1, 0], [1, 0], [0, -1], [0, 1]];for (const [dx, dy] of dirs) {const nx = x + dx, ny = y + dy;const ch = (map[ny] || '')[nx];if (ch === undefined || ch === ' ') return true;}return false;}
function a18(){const l=W[cW].l[cL],H=l.m.length,Wm=Math.max(...l.m.map(r=>r.length));let minX=Wm,maxX=-1,minY=H,maxY=-1;for(let y=0;y<H;y++){const r=l.m[y]||'';for(let x=0;x<Wm;x++)if(r[x]&&r[x]!==' '){minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y)}}
const cx=(minX+maxX)/2-halfX,cz=(minY+maxY)/2-halfZ,md=Math.max(maxX-minX+1,maxY-minY+1);controls.target.set(cx,-.9,cz);controls.minRadius=Math.max(3,md*.9);controls.maxRadius=Math.max(15,md*4);controls.radius=Math.min(controls.maxRadius,Math.max(controls.minRadius,md*2.2));controls.theta=Math.PI/4.5;controls.phi=Math.PI/3.2;controls.update()}
function a21() {const wn = W[cW].n;const ln=cL + 1;document.getElementById("wl").textContent = `${wn}`;document.getElementById("ln").textContent = `Level ${ln}`;}function a10(x,y){const l=W[cW].l[cL];if(y<0||y>=l.m.length)return'0';const r=l.m[y]||'';return(x<0||x>=r.length)?'0':r[x]||'0'}
function a3(x,y){const c=a10(x,y);return c!=='1'&&c!==' '}function a9(x,y){return gO.find(o=>o.type==='box'&&o.x===x&&o.y===y)}function a20(dx,dy){clrHint();if(isMoving)return;const nx=catX+dx,ny=catY+dy;if(!a3(nx,ny))return;Board3D.faceCat(dx,dy);const b=a9(nx,ny);sfx.step();if(b){const bx=b.x+dx,by=b.y+dy;if(!a3(bx,by)||a9(bx,by))return;isMoving=!0;b.x=bx;b.y=by;Board3D.moveTo(b.id,toWorldX(bx),toWorldZ(by));const t=gO.find(o=>o.type==='target'&&o.x===bx&&o.y===by);b.onTarget=!!t;Board3D.rcBx(b.id,b.onTarget);setTimeout(()=>{catX=nx;catY=ny;Board3D.moveTo('cat',toWorldX(nx),toWorldZ(ny));moves++;document.getElementById("mc").textContent=moves;a22();isMoving=!1;if(solutionPath&&solutionPath[0]?.dx===dx&&solutionPath[0]?.dy===dy)solutionPath.shift();else solutionPath=null},100)}else{isMoving=!0;catX=nx;catY=ny;Board3D.moveTo('cat',toWorldX(nx),toWorldZ(ny));moves++;document.getElementById("mc").textContent=moves;setTimeout(()=>{isMoving=!1;if(solutionPath&&solutionPath[0]?.dx===dx&&solutionPath[0]?.dy===dy)solutionPath.shift();else solutionPath=null},100)}}function a22(){const tt=gO.filter(o=>o.type==='target').length,tl=gO.filter(o=>o.type==='box'&&o.onTarget).length;document.getElementById("tc").textContent=`${tl}/${tt}`;if(tl===tt&&tt>0)setTimeout(a11,1000)}
function getHint(){if(hintsThisLevel<=0){a19("No more hints. Try reset.",3000);return}solutionPath=a6();if(!solutionPath||!solutionPath.length){a19("Can't find path. Try moving.",2800);return}hintsThisLevel--;document.getElementById("hc").textContent=hintsThisLevel;if(hintsThisLevel<=0)document.getElementById("bh").disabled=!0;const m=solutionPath[0],tx=catX+m.dx,ty=catY+m.dy,b=a9(tx,ty);let msg=b?"Push box ":"Move ";msg+=m.dx>0?"right":m.dx<0?"left":m.dy>0?"down":"up";a19(msg,4000)}
function a19(m,d){const e=document.getElementById("hd");if(!e)return;e.textContent=m;e.style.display='block';clearTimeout(hintTimeout);hintTimeout=setTimeout(()=>e.style.display='none',d)}
function a6(){const targets=gO.filter(o=>o.type==='target'),boxes=gO.filter(o=>o.type==='box'),start={catX,catY,boxes:boxes.map(b=>({x:b.x,y:b.y})),moves:[]},queue=[start],visited=new Set,maxIt=8000;let it=0;
const a16=st=>`${st.catX},${st.catY}:${st.boxes.map(b=>`${b.x},${b.y}`).sort().join('|')}`,isSolved=st=>targets.every(t=>st.boxes.some(b=>b.x===t.x&&b.y===t.y));while(queue.length&&it++<maxIt){const st=queue.shift(),k=a16(st);if(visited.has(k))continue;visited.add(k);if(isSolved(st))return st.moves;const dirs=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];for(const d of dirs){const nx=st.catX+d.dx,ny=st.catY+d.dy,bi=st.boxes.findIndex(b=>b.x===nx&&b.y===ny);if(bi!==-1){const bnx=nx+d.dx,bny=ny+d.dy,c=a10(bnx,bny);if(c==='1'||c===' '||st.boxes.some(b=>b.x===bnx&&b.y===bny))continue;const nb=st.boxes.map((b,i)=>i===bi?{x:bnx,y:bny}:{x:b.x,y:b.y});queue.push({catX:nx,catY:ny,boxes:nb,moves:st.moves.concat({dx:d.dx,dy:d.dy})})}else{const c=a10(nx,ny);if(c==='1'||c===' '||st.boxes.some(b=>b.x===nx&&b.y===ny))continue;queue.push({catX:nx,catY:ny,boxes:st.boxes.map(b=>({x:b.x,y:b.y})),moves:st.moves.concat({dx:d.dx,dy:d.dy})})}}}return null}
function a11(){clrHint();const tt=gO.filter(o=>o.type==='target').length,par=Math.max(6,tt*5),hu=3-hintsThisLevel,sc=hu>0?1:moves<=par?3:moves<=par*1.25?2:1;sts.totalMoves+=moves;sts.levelsCleared+=1;if(a13()&&a14()){setTimeout(()=>{m.style.display='none';a8();},2000);sfx.target();return;}document.getElementById("sd").innerHTML='★'.repeat(sc)+'☆'.repeat(3-sc);document.getElementById("sd").style.color='#FFD700';const m=document.getElementById("lc");if(m){m.style.display='block';document.getElementById("bh").disabled=true;document.querySelector('button[onclick="rstLvl()"]').disabled=true;setTimeout(()=>m.querySelector('button').focus(),100);}sfx.target();}
function rtyLvl(){document.getElementById("lc").style.display='none';document.getElementById("bh").disabled=hintsThisLevel<=0;document.querySelector('button[onclick="rstLvl()"]').disabled=false;rstLvl()}
function rstLvl(){clrHint();document.getElementById("lc").style.display='none';solutionPath=null;hintsThisLevel=3;document.getElementById("hc").textContent=hintsThisLevel;document.getElementById("bh").disabled=!1;a12()}
function a2(wi){const p=P[wi]||P[0];[C.grass,C.grassEdge]=x(p.g);[C.ground,C.groundEdge]=x(p.G);[C.path,C.pathEdge]=x(p.p);[C.tree,C.treeEdge]=x(p.t);[C.trunk, C.trunkEdge] = x(p.T);[C.box,C.boxEdge]=x(p.b);[C.target,C.targetEdge]=x(p.a);C.gradient = p.d;document.body.style.background = C.gradient;}
function a13(){return cL>=W[cW].l.length-1}function a14(){return cW>=W.length-1}function a8(){isGameOver=!0;try{sfx.target()}catch(e){}const ms=Math.max(0,Date.now()-sts.startAt);const mins=Math.floor(ms/60000);const secs=String(Math.floor((ms%60000)/1000)).padStart(2,'0');const stats=`Cleared ${sts.levelsCleared} levels • ${sts.totalMoves} moves • ${mins}:${secs}`;const el=document.getElementById("gs");if(el)el.textContent=stats;const modal=document.getElementById("gc");if(modal){modal.style.display='block';setTimeout(()=>modal.querySelector('button').focus(),100)}}
function rstGame(){const m=document.getElementById("gc");if(m)m.style.display='none';isGameOver=!1;cW=0;cL=0;sts={totalMoves:0,levelsCleared:0,startAt:Date.now()};hintsThisLevel=3;document.getElementById('hc').textContent=hintsThisLevel;document.getElementById('bh').disabled=!1;a2(0);a12();}
function cntToNxtLvl(){document.getElementById("lc").style.display='none';document.getElementById("bh").disabled=false;document.querySelector('button[onclick="rstLvl()"]').disabled=false;sts.totalMoves+=moves;sts.levelsCleared+=1;let nw=cW,nl=cL+1;if(nl>=W[cW].l.length){nw++;nl=0;if(nw>=W.length){a8();return}}cW=nw;cL=nl;a2(cW);a12();}
function cs(){let f=document.getElementById('s');for(let i=0;i<150;i++){let s=document.createElement('div');s.className='star';s.style.width=s.style.height='2px';s.style.left=Math.random()*100+'%';s.style.top=Math.random()*100+'%';s.style.animationDelay=Math.random()*4+'s';f.appendChild(s)}}cs();
document.addEventListener('keydown',e=>{if(isMoving)return;switch(e.code){case'ArrowUp':case'KeyW':a20(0,-1);break;case'ArrowDown':case'KeyS':a20(0,1);break;case'ArrowLeft':case'KeyA':a20(-1,0);break;case'ArrowRight':case'KeyD':a20(1,0);break}e.preventDefault()});
let t0=performance.now();(function a17(t){const dt=(t-t0)/1000;t0=t;Board3D.update?.(dt);renderer.render(scene,cam,[.6,1,.5]);requestAnimationFrame(a17)})(t0);
window.addEventListener('DOMContentLoaded',()=>{a2(0);a12()});if(document.readyState!=='loading'){a2(0);a12()}</script></body></html>